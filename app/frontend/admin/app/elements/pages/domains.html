<!--
  Domains Management
  @author: jldupont
  @dependencies:  api
-->

<link rel="import" href="dialog-domains.html">

<dom-module id="page-domains">
  <template>
  
  	<style>
  	 #button_add {
  	 	color: #db4437;
  	 };
  	</style>
  
	<paper-icon-button id="button_add" icon="add-circle"
	title='add domain'
	data-required-permission="domain:create"
	><paper-icon-button>
  
  	<iron-ajax is='dom-bind' id='ajaxdomains'
  		handle-as="json"
  		url="/_api/domain"
  		on-response ="_handleResponse"
  	></iron-ajax>
  
  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'page-domains',
      
      properties: {
    	  
      },
      
      init_api: function(scheme_host_port, headers){

    	this.ajax_domains = this.$.ajaxdomains;

    	// iron-ajax builds a full URL
    	//  but we just want the 'path' part
    	var uri_parts = uri.parse(this.ajax_domains.url);
    	var url_path = uri_parts.path;
    	
    	var url = scheme_host_port + "/" + url_path;
    	
    	this.ajax_domains.url = url;
    	this.ajax_domains.auto = true;
    	this.ajax_domains.headers = headers;  
      },
      
      _handleResponse: function(event){
    	  var response = event.detail.response;
    	  console.log(response);
      },
      
      start_add_domain : function(){
    	  document.querySelector("#dialogAddDomain").open();  
      },
      
      ready: function(){
    	var self = this;
    	
    	this.$.button_add.addEventListener("click", function(){
    		self.start_add_domain();	
    	});
    	
    	mbus.subscribe("intent-domain-create", function(details){
    		
    		//console.log("Intent: domain add: ", details);
    		
    		details.cb_success = function(){
    			mbus.publish("R-success");
    		};
    		details.cb_error = function(context, status, response){
    			
    			var eclass = (response.eclass || "").toLowerCase();

    			if (eclass=='existserror')
    				mbus.publish("R-exists:resource", {name: 'domain'});
    		};
    		
    		api.domain_create(details);
    		
    	});
    	
    	
      },
      
    });
  })();
</script>
